#include <stdio.h>
#include <stdlib.h>
#include <conio.h>
#include <windows.h>  // STRUKTURA COORD POSTOJI U OVO LIBRARIJU
#include <string.h>
#include <time.h>
// MUSIC, TREBA I LINKER STAVITI(DESNI KLIK NA Projeckt 1 --> BUILD OPTIONS --> LINKER SETTINGS --> U OTHER UBACITI "-lwinmm")

typedef struct{
    char name[30+1];
    int score;
}Person;

//typedef struct _COORD {
//  SHORT X;
//  SHORT Y;
//} COORD, *PCOORD;
COORD coord = {0,0};

void preload();
void gotoxy(int x,int y);
void delay(unsigned int a);

int main()
{
    srand(time(NULL));
    int value[]={'A',2,3,4,5,6,7,8,9,10,'J','Q','K'};
    char suit[]={3,4,5,6};
    int i,j,z=0,n=0;
    int music=0;
    Person*list=malloc(sizeof(Person)*1000);
    char choice;
    PlaySound(TEXT("intro.wav"),NULL,SND_ASYNC|SND_NOSTOP);
    preload();
    //PlaySound(TEXT("music.wav"),NULL,SND_ASYNC|SND_LOOP|SND_NOSTOP|SND_NODEFAULT|SND_NOWAIT|SND_APPLICATION|SND_FILENAME);
    PlaySound(TEXT("in.wav"),NULL,SND_ASYNC|SND_NOSTOP);// MUSIC
    while(1){
        system("cls");
        gotoxy(2,2);
        printf("NAVIGATION: Press the numbers to navigate.");
        gotoxy(2,4);
        printf("PRESS 0 for the rules.");
        gotoxy(30,6);
        printf("1. Play Black Jack");
        gotoxy(30,8);
        printf("2. Show High Scores");
        gotoxy(30,10);
        printf("3. Delete High Scores");
        gotoxy(30,12);
        printf("4. Exit");
        gotoxy(30,14);
        printf("#!#Extra options if speakers on#!#");
        gotoxy(30,16);
        printf("5. Play music (Trun sounds off!)");
        gotoxy(30,18);
        printf("6. Turn off music (Turn sounds on!)");
        gotoxy(30,20);//- ZA MOJ EKRAN TAMAN ZA STAVITI KARTE
        fflush(stdin);
        choice  = getche();
        if(choice == '4'){
            if(music!=1){
               PlaySound(TEXT("in.wav"),NULL,SND_ASYNC);
            }
            while(1){
                system("cls");
                gotoxy(22,10);
                printf("Are you sure you want to exit?");
                gotoxy(30,12);
                printf("1. Yes");
                gotoxy(30,14);
                printf("2. No");
                gotoxy(30,16);
                fflush(stdin);
                choice = getche();
                if(choice == '1'){
                    if(music!=1){
                        PlaySound(TEXT("end.wav"),NULL,SND_ASYNC);
                    }
                    system("cls");
                    gotoxy(30,8);
                    printf("Signing off, please wait.");
                    z=30;
                    for(i=0;i<6;i++){
                        gotoxy(z,10);
                        printf(". ");
                        z+=2;
                        delay(1);
                    }
                    exit(1);
                }else if(choice == '2'){
                    if(music!=1){
                        PlaySound(TEXT("out.wav"),NULL,SND_ASYNC);
                    }
                    break;
                }
            }
        }else if(choice == '3'){
            if(music!=1){
               PlaySound(TEXT("in.wav"),NULL,SND_ASYNC);
            }
            while(1){
                system("cls");
                gotoxy(22,10);
                printf("Are you sure you want to delete the high scores?");
                gotoxy(30,12);
                printf("1. Yes");
                gotoxy(30,14);
                printf("2. No");
                gotoxy(30,16);
                fflush(stdin);
                choice = getche();
                if(choice == '1'){
                    if(music!=1){
                        PlaySound(TEXT("clean.wav"),NULL,SND_ASYNC);
                    }
                    system("cls");
                    gotoxy(30,10);
                    printf("The scores have been deleted!");
                    FILE*fin=fopen("HighScores.txt","w");
                    fclose(fin);
                    delay(3);
                    break;
                }else if(choice == '2'){
                    if(music!=1){
                        PlaySound(TEXT("out.wav"),NULL,SND_ASYNC);
                    }
                    break;
                }
            }
        }else if(choice == '2'){
            // TREBA DODATI SORT ZA HIGH SCOREEEEEE!!!
            if(music!=1){
               PlaySound(TEXT("in.wav"),NULL,SND_ASYNC);
            }
            system("cls");
            fflush(stdin);
            FILE*fin=fopen("HighScores.txt","r");
            int n1=0,n2=8;
            while(fscanf(fin,"%[^:]: %d$%*[\n]",list[n1].name,&list[n1].score)==2){
                //gotoxy(30,n2);
                //printf("%d. %s: %d$",n1+1,list[n1].name,list[n1].score);
                n1++;
                //n2+=2;
            }
            // SORT
            for(i=0;i<n1;i++){
                for(j=i+1;j<n1;j++){
                    if(list[i].score<list[j].score){
                        Person temp=list[i];
                        list[i]=list[j];
                        list[j]=temp;
                    }
                }
            }
            for(i=0;i<n1;i++){
                gotoxy(30,n2);
                printf("%d. %s: %d$",i+1,list[i].name,list[i].score);
                n2++;
            }
            gotoxy(1,1);
            printf("Press any key to exit.");
            choice = getche();
            if(music!=1){
               PlaySound(TEXT("out.wav"),NULL,SND_ASYNC);
            }
            n=n1;
            fclose(fin);
        }else if(choice == '5'){
            music=1;
            PlaySound(TEXT("music.wav"),NULL,SND_ASYNC|SND_LOOP);
        }else if(choice =='6'){
            music=0;
            PlaySound(TEXT("out.wav"),NULL,SND_ASYNC);
        }else if(choice == '0'){
            system("cls");
            if(music!=1){
               PlaySound(TEXT("in.wav"),NULL,SND_ASYNC);
            }
            gotoxy(1,1);
            printf("Press any key to exit.");
            gotoxy(2,3);
            printf("BLACK JACK!");
            gotoxy(4,5);
            printf("Get as close to 21 as possible, without going over 21.");
            gotoxy(4,7);
            printf("The ace is worth 1 or 11. Face cards are 10, all others by their value.");
            gotoxy(4,9);
            printf("HIT - Get another card.");
            gotoxy(4,11);
            printf("STAND - You are don't want any more cards.");
            gotoxy(4,13);
            printf("DOUBLE DOWN - Get only one more card and double the bet.");
            choice = getche();
            if(music!=1){
               PlaySound(TEXT("out.wav"),NULL,SND_ASYNC);
            }
        }else if(choice == '1'){
            //INTRO
            system("cls");
            if(music!=1){
               PlaySound(TEXT("in.wav"),NULL,SND_ASYNC);
            }
            //TREBA DODATI MUSIC OD OVDJE PA DO DOLE!!!
            gotoxy(22,10);
            printf("You will get 500$, try to get more.");
            delay(3);
            gotoxy(22,12);
            printf("If you lose your money it's game over");
            delay(3);
            gotoxy(22,14);
            printf("You can end at any time, good luck :D");
            delay(3);
            fflush(stdin);
            //VALET + GAME LOOP
            int cash=500;
            int bet=0;
            int out=0;
            int goodBet=0;
            while(1){
                system("cls");
                gotoxy(2,2);
                printf("Cash: %d$",cash);
                gotoxy(2,4);
                printf("Bet:");
                gotoxy(2,16);
                printf("Enter 0 for the bet to exit.");
                gotoxy(2,6);
                printf("RULES:");
                gotoxy(2,7);
                printf("1-HIT");
                gotoxy(2,8);
                printf("2-STAND");
                gotoxy(2,9);
                printf("3-DOUBLE DOWN");
                gotoxy(39,6);// DEALER
                printf("Dealers hand:");
                gotoxy(40,18);//YOU
                printf("Your Hand:");
                gotoxy(7,4);

                scanf("%d",&bet);
                if(bet<0){
                    gotoxy(13,4);
                    printf("Come on bruh...");
                    delay(2);
                }else if(bet==0){
                    out=1;
                }else if(bet<=cash){
                    gotoxy(7,4);
                    printf("%d$",bet);
                    gotoxy(2,2);
                    printf("Cash: %d$",cash-bet);
                    goodBet=1;
                    gotoxy(17,13);
                }else{
                    gotoxy(13,4);
                    printf("You don't have enough cahs!");
                    delay(2);
                }

                //EXIT IZ GAME LOOPA
                if(out==1){
                    system("cls");
                    gotoxy(22,10);
                    printf("Do you want to save your score?");
                    gotoxy(22,12);
                    printf("1. Yes");
                    gotoxy(22,14);
                    printf("2. No");
                    choice=getche();
                    if(choice == '1'){
                        system("cls");
                        char name[30+1];
                        gotoxy(22,10);
                        printf("Enter your name:");
                        gotoxy(22,12);
                        scanf("%s",name);
                        FILE*fin=fopen("HighScores.txt","a");
                        fseek(fin,0,SEEK_END);
                        fprintf(fin,"%s: %d$\n",name,cash);
                        rewind(fin);
                        fclose(fin);
                    }
                    system("cls");
                    gotoxy(22,10);
                    printf("Thanks for playing!");
                    break;
                }
                //GENERATOR Treba dodati posebni x++ kao i kod stringova kad sam radio!
                int sideA[20],sideB[20];
                int A,B;
                for(i=0;i<15;i++){
                    A=rand()%13;
                    B=rand()%4;
                    sideA[i]=A;
                    sideB[i]=B;
                }
                //TEST-- RADI!! YAY
//                for(i=0;i<15;i++){
//                    if(sideA[i]==0||sideA[i]>9){
//                        printf("|%c%c| ",value[sideA[i]],suit[sideB[i]]);
//                    }else{
//                        printf("|%d%c| ",value[sideA[i]],suit[sideB[i]]);
//                    }
//                }
                //PROVJERA ZA SLOVO I REFRESH ZA SLOVO
                while(1){
                    if(goodBet==1){
                        fflush(stdin);
                        choice= getche();
                        printf("\b");
                    }else{
                        break;
                    }
                }
                goodBet=0;
            }
        }
    }

    return 0;
}
// FUNKCIJE
void delay(unsigned int a){
    unsigned int wait = time(0) + a;
    while(time(0)<wait);
}

void gotoxy(int x,int y){
    coord.X = x;
    coord.Y = y;
    SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE),coord);
}

void preload(){
    gotoxy(30,8);
    printf("BLACK JACK!");
    int i,z=30;
    for(i=0;i<6;i++){
        gotoxy(z,10);
        printf(". ");
        z+=2;
        delay(1);
    }
    gotoxy(22,12);
    printf("Press Any Key To Continue...");
    getche();
}